<!-- CSS -->
<link href="https://artalk.zeven.site/dist/Artalk.css" rel="stylesheet">

<!-- JS -->

<!-- Artalk -->
<div id="Comments" class="comments-placeholder" aria-busy="true">
  <div class="spinner" aria-hidden="true"></div>
</div>

<script>
(function(){
  const ARTALK_SRC = 'https://artalk.zeven.site/dist/Artalk.js';

  function isDarkModeNow() {
    if (window.Theme && window.Theme.visualState) return window.Theme.visualState === 'dark';
    const attr = document.documentElement.getAttribute('data-mode');
    if (attr) return attr === 'dark';
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  }

  function cleanupPlaceholder() {
    const el = document.getElementById('Comments');
    if (!el) return;
    el.removeAttribute('aria-busy');
    const spinner = el.querySelector('.spinner'); if (spinner) spinner.remove();
  }

  function initArtalk() {
    // ensure theme attribute has been applied
    requestAnimationFrame(() => {
      const artalkInstance = window.Artalk.init({
        el: '#Comments',
        pageKey: '{{ .Page.RelPermalink }}',
        pageTitle: '{{ .Title }}',
        server: '{{ $.Site.Params.comments.artalk.server }}',
        site: '{{ $.Site.Params.comments.artalk.site }}',
        darkMode: Boolean(isDarkModeNow())
      });

      // remove spinner
      cleanupPlaceholder();

      // listen for theme flips
      window.addEventListener('message', (e) => {
        if (e && e.data && e.data.id === 'theme-mode') {
          artalkInstance.setDarkMode(isDarkModeNow());
        }
      });

      // compatibility with other events
      window.addEventListener('onColorSchemeChange', (e) => {
        artalkInstance.setDarkMode(e.detail === 'dark');
      });
    });
  }

  function loadScript(cb) {
    if (window.Artalk) { cb(); return; }
    const s = document.createElement('script');
    s.src = ARTALK_SRC; s.async = true; s.onload = cb; s.onerror = cb; document.head.appendChild(s);
  }

  if (window.Theme) {
    loadScript(initArtalk);
  } else {
    document.addEventListener('DOMContentLoaded', () => loadScript(initArtalk), { once: true });
  }
})();
</script>

<style>
  .comments-placeholder {min-height: 120px;display:flex;align-items:center;justify-content:center}
  .comments-placeholder .spinner{width:20px;height:20px;border-radius:50%;border:2px solid rgba(0,0,0,0.08);border-top-color:rgba(0,0,0,0.28);animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
