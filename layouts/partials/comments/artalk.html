<!-- CSS -->
<link href="https://artalk.zeven.site/dist/Artalk.css" rel="stylesheet">

<!-- JS -->
<script src="https://artalk.zeven.site/dist/Artalk.js"></script>

<!-- Artalk -->
<div id="Comments" style="visibility:hidden;opacity:0;transition:opacity .12s linear"></div>

<script>
  const artalkInstance = Artalk.init({
    el:        '#Comments',
    pageKey:   '{{ .Page.RelPermalink }}',
    pageTitle: '{{ .Title }}',
    server:    '{{ $.Site.Params.comments.artalk.server }}',
    site:      '{{ $.Site.Params.comments.artalk.site }}',
    darkMode:  '{{ $.Site.Params.comments.artalk.darkMode }}'
  })

  function isDarkModeNow() {
    if (window.Theme && window.Theme.visualState) {
      return window.Theme.visualState === 'dark';
    }
    const attr = document.documentElement.getAttribute('data-mode');
    if (attr) return attr === 'dark';
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  }

  // apply initial value
  artalkInstance.setDarkMode(Boolean(isDarkModeNow()));

  // reveal comments container after theme applied to avoid flash
  (function revealComments() {
    const $comments = document.getElementById('Comments');
    if (!$comments) return;
    // Reveal on next frame to ensure theme attribute was applied
    requestAnimationFrame(() => {
      $comments.style.visibility = 'visible';
      $comments.style.opacity = '1';
    });
  })();

  // listen for Theme.flip() notifications
  window.addEventListener('message', (e) => {
    if (e && e.data && e.data.id === 'theme-mode') {
      artalkInstance.setDarkMode(isDarkModeNow());
    }
  });

  // compatibility with other events
  window.addEventListener('onColorSchemeChange', (e) => {
    artalkInstance.setDarkMode(e.detail == 'dark')
  })
</script>
