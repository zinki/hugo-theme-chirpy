<!-- CSS -->
<link href="https://artalk.zeven.site/dist/Artalk.css" rel="stylesheet">

<!-- JS -->
<script src="https://artalk.zeven.site/dist/Artalk.js"></script>

<!-- Artalk -->
<div id="Comments" style="visibility:hidden;opacity:0;transition:opacity .12s linear"></div>

<script>
  function isDarkModeNow() {
    if (window.Theme && window.Theme.visualState) {
      return window.Theme.visualState === 'dark';
    }
    const attr = document.documentElement.getAttribute('data-mode');
    if (attr) return attr === 'dark';
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  }

  // initialize with current theme so internal render uses correct style
  const artalkInstance = Artalk.init({
    el:        '#Comments',
    pageKey:   '{{ .Page.RelPermalink }}',
    pageTitle: '{{ .Title }}',
    server:    '{{ $.Site.Params.comments.artalk.server }}',
    site:      '{{ $.Site.Params.comments.artalk.site }}',
    darkMode:  Boolean(isDarkModeNow())
  });

  // reveal only after Artalk has rendered (avoid flash). fallback after 2s.
  (function waitForRenderAndReveal() {
    const $comments = document.getElementById('Comments');
    if (!$comments) return;
    const start = Date.now();
    const timeout = 2000; // ms

    function check() {
      // childElementCount indicates Artalk has populated DOM
      if ($comments.childElementCount > 0) {
        requestAnimationFrame(() => {
          $comments.style.visibility = 'visible';
          $comments.style.opacity = '1';
        });
        return;
      }
      if (Date.now() - start > timeout) {
        // fallback: reveal even if not populated to avoid permanent hidden state
        $comments.style.visibility = 'visible';
        $comments.style.opacity = '1';
        return;
      }
      requestAnimationFrame(check);
    }
    // start checking on next frame so theme attribute has time to apply
    requestAnimationFrame(check);
  })();

  // listen for Theme.flip() notifications
  window.addEventListener('message', (e) => {
    if (e && e.data && e.data.id === 'theme-mode') {
      artalkInstance.setDarkMode(isDarkModeNow());
    }
  });

  // compatibility with other events
  window.addEventListener('onColorSchemeChange', (e) => {
    artalkInstance.setDarkMode(e.detail == 'dark');
  });
</script>
